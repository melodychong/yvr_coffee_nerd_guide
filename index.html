<!DOCTYPE html><html lang="en"><head><meta name="x-poe-datastore-behavior" content="local_only"><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YVR Coffee Nerd Guide ☕︎</title>
    
    <!-- Google Fonts - Caveat, Poppins, and Catamaran -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;500;600;700&amp;family=Poppins:wght@300;400;500;600;700&amp;family=Catamaran:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet">
    
    <style>
        :root {
            --dark-blue: #4A00C9;
            --portland-orange: #FF5E32;
            --white-chocolate: #EFE7D3;
            --june-bud: #B7CF4F;
            --purple: #8B5A96;
            --white: #FFFFFF;
            --dark-text: #1A1A1A;
            --medium-text: #444444;
            --light-text: #666666;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', 'Catamaran', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--white);
            color: var(--dark-text);
            line-height: 1.6;
        }

        .container {
            max-width: 100vw;
            height: 100vh;
            display: flex;
        }

        .sidebar {
            width: 400px;
            background: var(--white-chocolate);
            padding: 30px;
            overflow-y: auto;
            border-right: 3px solid var(--dark-blue);
            display: flex;
            flex-direction: column;
        }

        .sidebar-content {
            flex: 1;
        }

        .header {
            margin-bottom: 30px;
            padding: 25px;
            background: var(--dark-blue);
            border-radius: 16px;
            color: var(--white);
        }

        .header h1 {
            font-size: 3.2rem;
            color: var(--white);
            margin-bottom: 12px;
            font-weight: 700;
            font-family: 'Caveat', cursive;
            line-height: 1.1;
        }

        .category {
            margin-bottom: 20px;
            background: var(--white);
            border-radius: 12px;
            border: 2px solid transparent;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .category:hover {
            transform: translateY(-2px);
        }

        .category-header {
            display: flex;
            align-items: center;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 12px;
        }

        .category-dot {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            margin-right: 15px;
            border: 3px solid var(--white);
        }

        .best-dot { background: var(--dark-blue); }
        .hidden-dot { background: var(--portland-orange); }
        .work-dot { background: var(--june-bud); }
        .honorable-dot { background: var(--purple); }

        .category.best { border-color: var(--dark-blue); }
        .category.hidden { border-color: var(--portland-orange); }
        .category.work { border-color: var(--june-bud); }
        .category.honorable { border-color: var(--purple); }

        .category.best .category-header:hover { background: rgba(74, 0, 201, 0.1); }
        .category.hidden .category-header:hover { background: rgba(255, 94, 50, 0.1); }
        .category.work .category-header:hover { background: rgba(183, 207, 79, 0.1); }
        .category.honorable .category-header:hover { background: rgba(139, 90, 150, 0.1); }

        .category-title {
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            flex: 1;
            color: var(--dark-text);
            font-size: 1rem;
            font-family: 'Poppins', sans-serif;
        }

        .category-toggle {
            font-size: 1rem;
            color: var(--medium-text);
            margin-left: 10px;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
        }

        .category-items {
            padding-left: 35px;
            padding-right: 20px;
            padding-bottom: 0;
            margin-top: 0;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease;
        }

        .category.expanded .category-items {
            max-height: 2000px;
            padding-bottom: 15px;
            margin-top: 5px;
        }

        .category.expanded .category-toggle::before {
            content: '▲';
        }

        .category-toggle::before {
            content: '▼';
        }

        .category-item {
            padding: 12px 16px;
            color: var(--medium-text);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95rem;
            line-height: 1.5;
            margin: 4px 0;
            border-radius: 8px;
            border-left: 4px solid transparent;
            font-family: 'Catamaran', sans-serif;
            font-weight: 400;
        }

        .category-item:hover {
            color: var(--dark-text);
            background: var(--white-chocolate);
            transform: translateX(4px);
            font-weight: 500;
        }

        .category.best .category-item:hover { border-left-color: var(--dark-blue); }
        .category.hidden .category-item:hover { border-left-color: var(--portland-orange); }
        .category.work .category-item:hover { border-left-color: var(--june-bud); }
        .category.honorable .category-item:hover { border-left-color: var(--purple); }

        .category-item.active {
            color: var(--white);
            font-weight: 600;
            transform: translateX(4px);
            font-family: 'Poppins', sans-serif;
        }

        .category.best .category-item.active { 
            background: var(--dark-blue);
            border-left-color: var(--dark-blue);
        }
        .category.hidden .category-item.active { 
            background: var(--portland-orange);
            border-left-color: var(--portland-orange);
        }
        .category.work .category-item.active { 
            background: var(--june-bud);
            border-left-color: var(--june-bud);
            color: var(--dark-text);
        }
        .category.honorable .category-item.active { 
            background: var(--purple);
            border-left-color: var(--purple);
        }

        .buy-coffee-link {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: var(--dark-blue);
            color: var(--white);
            padding: 12px 20px;
            border-radius: 12px;
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 600;
            font-family: 'Poppins', sans-serif;
            margin-top: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            border: 2px solid var(--dark-blue);
            gap: 8px;
        }

        .buy-coffee-link:hover {
            background: var(--white);
            border-color: var(--dark-blue);
            color: var(--dark-blue);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(74, 0, 201, 0.3);
        }

        .sidebar-credit {
            margin-top: 15px;
            padding: 15px;
            background: var(--white);
            border-radius: 8px;
            border: 2px solid var(--light-text);
            text-align: left;
            font-size: 0.85rem;
            color: var(--medium-text);
            font-family: 'Catamaran', sans-serif;
        }

        .sidebar-credit a {
            color: var(--dark-text);
            text-decoration: none;
            font-weight: 500;
        }

        .sidebar-credit a:hover {
            text-decoration: underline;
        }

        #map {
            flex: 1;
            height: 100vh;
            position: relative;
            background: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .loading-message {
            text-align: center;
            color: var(--dark-text);
            font-size: 1.1rem;
            background: var(--white-chocolate);
            padding: 40px;
            border-radius: 16px;
            border: 3px solid var(--dark-blue);
            font-family: 'Poppins', sans-serif;
            font-weight: 400;
        }

        .loading-spinner {
            border: 4px solid var(--white-chocolate);
            border-top: 4px solid var(--dark-blue);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Custom marker styles */
        .custom-marker {
            border-radius: 50%;
            border: 3px solid var(--white);
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .custom-marker:hover {
            transform: scale(1.6);
            z-index: 1000;
        }

        .mapboxgl-popup {
            max-width: 300px;
        }

        .mapboxgl-popup-content {
            padding: 24px;
            border-radius: 16px;
            font-family: 'Poppins', sans-serif;
            background: var(--white);
            border: 3px solid var(--dark-blue);
        }

        .popup-content h3 {
            color: var(--dark-blue);
            margin-bottom: 12px;
            font-size: 1.6rem;
            font-weight: 700;
            font-family: 'Caveat', cursive;
            line-height: 1.2;
        }

        .popup-content p {
            margin-bottom: 10px;
            font-size: 0.95rem;
            color: var(--medium-text);
            font-family: 'Catamaran', sans-serif;
            line-height: 1.6;
            font-weight: 400;
        }

        .popup-content p strong {
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            color: var(--dark-text);
        }

        .popup-content .address-link {
            color: var(--dark-text);
            text-decoration: underline;
            font-weight: 600;
            font-family: 'Poppins', sans-serif;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .popup-content .address-link:hover {
            color: var(--dark-text);
            text-decoration: underline;
        }

        .popup-content .website-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: var(--portland-orange);
            color: var(--white);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            text-decoration: none;
            font-size: 1.2rem;
            margin-top: 15px;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }

        .popup-content .website-icon:hover {
            background: var(--dark-blue);
            transform: translateY(-2px);
        }

        .retry-button {
            background: var(--portland-orange);
            color: var(--white);
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            font-family: 'Poppins', sans-serif;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.3s ease;
        }

        .retry-button:hover {
            background: var(--dark-blue);
            transform: translateY(-1px);
        }

        .geocoding-status {
            background: var(--june-bud);
            color: var(--dark-text);
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.8rem;
            margin-bottom: 10px;
            font-family: 'Catamaran', sans-serif;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: 40vh;
                order: 2;
            }
            
            #map {
                height: 60vh;
                order: 1;
            }
            
            .header h1 {
                font-size: 2.5rem;
            }

            .sidebar-credit {
                font-size: 0.8rem;
                padding: 12px;
            }

            .buy-coffee-link {
                font-size: 0.85rem;
                padding: 10px 16px;
            }
        }
    </style>
<script src="https://puc.poecdn.net/authenticated_preview_page/syncedState.bd4eeeb8e8e02052ee92.js"></script></head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="sidebar-content">
                <div class="header">
                    <h1>YVR Coffee Nerd Guide ☕︎</h1>
                </div>

                <div class="geocoding-status" id="geocoding-status">
                    Espresso-ing locations onto the map... ☕
                </div>

                <div class="category best expanded">
                    <div class="category-header" onclick="toggleCategory(this)">
                        <div class="category-dot best-dot"></div>
                        <div class="category-title">Best of the Best 🔝</div>
                        <div class="category-toggle"></div>
                    </div>
                    <div class="category-items">
                        <div class="category-item" data-address="8280 Lansdowne Rd #110, Richmond, BC V6X 0B2">R Ki Coffee Lab</div>
                        <div class="category-item" data-address="1548 W 2nd Ave, Vancouver, BC V6J 1H2">Oidé Coffee</div>
                        <div class="category-item" data-address="325 Cambie St, Vancouver, BC V6B 2N4">Revolver</div>
                        <div class="category-item" data-address="112 W Broadway, Vancouver, BC V5Y 1P1">Coffee Roastery Modus</div>
                        <div class="category-item" data-address="550 Clark Dr, Vancouver, BC V5L 3H7">Yuán Coffee</div>
                        <div class="category-item" data-address="4360 Marine Dr, West Vancouver, BC V7V 1P1">Isetta Cafe Bistro</div>
                        <div class="category-item" data-address="555 Great Northern Way, Vancouver, BC V5T 1E1">Nemesis Coffee GNW</div>
                    </div>
                </div>

                <div class="category hidden">
                    <div class="category-header" onclick="toggleCategory(this)">
                        <div class="category-dot hidden-dot"></div>
                        <div class="category-title">Hidden 💎</div>
                        <div class="category-toggle"></div>
                    </div>
                    <div class="category-items">
                        <div class="category-item" data-address="960 Quayside Dr Unit 115, New Westminster, BC V3M 6G2">Craft Cafe</div>
                        <div class="category-item" data-address="2040 Quebec St, Vancouver, BC V5T 1Z7">cowdog coffee</div>
                        <div class="category-item" data-address="2263 E Hastings St, Vancouver, BC V5L 1V3">Doe Coffee</div>
                        <div class="category-item" data-address="1965 W 4th Ave #103, Vancouver, BC V6J 1M8">Lumine Coffee</div>
                        <div class="category-item" data-address="311 W Cordova St, Vancouver, BC V6B 4K2">Timbertrain Coffee Roasters - Gastown</div>
                        <div class="category-item" data-address="319 Carrall St, Vancouver, BC V6B 2J4">East Van Roasters</div>
                        <div class="category-item" data-address="2624B St Johns St, Port Moody, BC V3H 2B6">KAFFI Espresso Bar</div>
                        <div class="category-item" data-address="1945 Cornwall Ave, Vancouver, BC V6J 1C8">Kits Beach Coffee</div>
                        <div class="category-item" data-address="388 W 6th Ave, Vancouver, BC V5Y 1L1">Small Victory Bakery</div>
                        <div class="category-item" data-address="1025 Dunsmuir St, Vancouver, BC V7X 1M5">FUNK. Coffee Bar</div>
                        <div class="category-item" data-address="5000 Kingsway #140, Burnaby, BC V5H 2E4">Single V Coffee</div>
                        <div class="category-item" data-address="4501 North Rd #219, Burnaby, BC V3N 4R7">VERONI &amp; CO. Burnaby</div>
                        <div class="category-item" data-address="321 W Pender St, Vancouver, BC V6B 1T3">Saunter Coffee</div>
                        <div class="category-item" data-address="1502 Victoria Dr, Vancouver, BC V5L 2Y9">Mah Milk Bar - Victoria Dr</div>
                        <div class="category-item" data-address="55 6th St, New Westminster, BC V3L 0J2">Coasters Coffee</div>
                        <div class="category-item" data-address="539 Artisan Ln, Bowen Island, BC V0N 1G0">Artisan Eats Café &amp; Fine Foods</div>
                        <div class="category-item" data-address="1415 Bewicke Ave, North Vancouver, BC V7M 3B8">NOMAD Coffee &amp; Bakery</div>
                        <div class="category-item" data-address="4160 Fraser St, Vancouver, BC V5V 4E8">Slo Coffee</div>
                        <div class="category-item" data-address="425 Carrall St, Vancouver, BC V6B 6E3">Aiyaohno Cafe</div>
                        <div class="category-item" data-address="2042 W 4th Ave, Vancouver, BC V6J 1M9">Their There</div>
                        <div class="category-item" data-address="2601 Quebec St, Vancouver, BC V5T 3A6">The Federal Store Luncheonette &amp; Grocer</div>
                        <div class="category-item" data-address="620 Quebec St, Vancouver, BC V6A 4E7">Annabelle's</div>
                        <div class="category-item" data-address="688 W 58th Ave, Vancouver, BC V6P 0K1">Cafe Algan</div>
                        <div class="category-item" data-address="6450 Roberts St #100, Burnaby, BC V5G 4E1">Hooray Cafe &amp; Coffee Lab</div>
                        <div class="category-item" data-address="1555 Yew St, Vancouver, BC V6K 3E5">Viva Cafe &amp; Bakery</div>
                        <div class="category-item" data-address="3537 Princeton Ave, Coquitlam, BC V3E 0P1">Ibex café + kitchen</div>
                        <div class="category-item" data-address="3511 Moncton St, Richmond, BC V7E 3A3">Steveston Coffee Company</div>
                        <div class="category-item" data-address="810 Union St, Vancouver, BC V6A 2C4">Union Market</div>
                        <div class="category-item" data-address="3615 Kingsway, Vancouver, BC V5R 5M1">Jack's Spot</div>
                    </div>
                </div>

                <div class="category honorable">
                    <div class="category-header" onclick="toggleCategory(this)">
                        <div class="category-dot honorable-dot"></div>
                        <div class="category-title">Honorable Mention ✨</div>
                        <div class="category-toggle"></div>
                    </div>
                    <div class="category-items">
                        <div class="category-item" data-address="1089 Marinaside Crescent, Vancouver, BC V6Z 2Z4">Small Victory Bakery</div>
                        <div class="category-item" data-address="315 Carrall St, Vancouver, BC V6B 2J4">Nelson the Seagull Cafe</div>
                        <div class="category-item" data-address="863 Beatty St, Vancouver, BC V6B 2M6">Rocanini Coffee Roasters</div>
                        <div class="category-item" data-address="883 E Hastings St, Vancouver, BC V6A 1R8">Prototype Coffee</div>
                    </div>
                </div>

                <div class="category work">
                    <div class="category-header" onclick="toggleCategory(this)">
                        <div class="category-dot work-dot"></div>
                        <div class="category-title">Work &amp; Study 💻</div>
                        <div class="category-toggle"></div>
                    </div>
                    <div class="category-items">
                        <div class="category-item" data-address="4501 North Rd #109A, Burnaby, BC V3N 4R7">Standing Egg Coffee</div>
                        <div class="category-item" data-address="3399 Cambie St, Vancouver, BC V5Z 2W6">JJ Bean Coffee Roasters</div>
                        <div class="category-item" data-address="338 Helmcken St, Vancouver, BC V6B 6C5">Analog Coffee</div>
                        <div class="category-item" data-address="4462 Beresford St., Burnaby, BC V5H 2Y8">Coffee loft</div>
                        <div class="category-item" data-address="1605 Manitoba St, Vancouver, BC V5Y 3B7">Terra Breads</div>
                        <div class="category-item" data-address="1033 Robson St, Vancouver, BC V6E 1A9">Good Earth Coffeehouse - Robson</div>
                        <div class="category-item" data-address="639 E 15th Ave, Vancouver, BC V5T 2R6">Matchstick Fraser Street</div>
                        <div class="category-item" data-address="55 Powell St, Vancouver, BC V6A 1E9">Birds &amp; The Beets</div>
                        <div class="category-item" data-address="209 E Pender St, Vancouver, BC V6A 1T8">Propaganda coffee</div>
                        <div class="category-item" data-address="2198 W 4th Ave, Vancouver, BC V6K 1N7">49th Parallel Café &amp; Lucky's Doughnuts - West 4th</div>
                        <div class="category-item" data-address="156 W 8th Ave, Vancouver, BC V5Y 1N2">Milano Coffee Roasters</div>
                        <div class="category-item" data-address="2980 Main St, Vancouver, BC V5T 3G3">Forecast Coffee</div>
                        <div class="category-item" data-address="1067 W Cordova St #150, Vancouver, BC V6C 1C7">Caffè Super Veloce</div>
                        <div class="category-item" data-address="2088 Commercial Dr, Vancouver, BC V5N 4B2">Grounds for Coffee</div>
                        <div class="category-item" data-address="682 W Broadway, Vancouver, BC V5Z 1G1">AVIK</div>
                        <div class="category-item" data-address="3713 Kensington Ave, Burnaby, BC V5B 0A7">Bastion Coffee + Kitchen</div>
                        <div class="category-item" data-address="1328 Richards St, Vancouver, BC V6B 3G6">Matchstick Yaletown</div>
                    </div>
                </div>
            </div>

            <a href="https://buymeacoffee.com/melodyoooo" target="_blank" class="buy-coffee-link">
                ☕ Buy me a coffee
            </a>

            <div class="sidebar-credit">
                curated and vibe-coded by Melody Chong with Claude<br>
                <a href="https://melodychongdesign.com" target="_blank">melodychongdesign.com</a> © 2025
            </div>
        </div>

        <div id="map">
            <div class="loading-message">
                <div class="loading-spinner"></div>
                <div>Loading Vancouver Coffee Map...</div>
                <div style="font-size: 0.8rem; margin-top: 10px; color: #999;">Adding the last drops of magic... ☕</div>
            </div>
        </div>
    </div>

    <script>
        let retryCount = 0;
        const maxRetries = 3;
        let map;
        let markers = [];
        let geocodedCount = 0;
        let totalShops = 0;

        function updateGeocodingStatus(current, total) {
            const statusEl = document.getElementById('geocoding-status');
            if (statusEl) {
                statusEl.textContent = `Espresso-ing locations onto the map... ${current}/${total} ☕`;
                if (current === total) {
                    statusEl.textContent = `✨ ${total} caffeinated destinations locked and loaded!`;
                    setTimeout(() => {
                        statusEl.style.display = 'none';
                    }, 3000);
                }
            }
        }

        function openInGoogleMaps(address) {
            const encodedAddress = encodeURIComponent(address);
            const googleMapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodedAddress}`;
            window.open(googleMapsUrl, '_blank');
        }

        function showLoadingMessage() {
            document.getElementById('map').innerHTML = `
                <div class="loading-message">
                    <div class="loading-spinner"></div>
                    <div>Loading Vancouver Coffee Map...</div>
                    <div style="font-size: 0.8rem; margin-top: 10px; color: #999;">Adding the last drops of magic... ☕</div>
                </div>
            `;
        }

        function showErrorMessage() {
            document.getElementById('map').innerHTML = `
                <div class="loading-message">
                    <div style="color: var(--dark-blue); font-weight: 600; margin-bottom: 15px;">⚠️ Map Loading Issue</div>
                    <div style="font-size: 1rem; margin-bottom: 15px;">Having trouble loading the interactive map.</div>
                    <div style="font-size: 0.85rem; color: var(--medium-text); line-height: 1.5; margin-bottom: 20px;">
                        This could be due to:<br>
                        • Network connectivity issues<br>
                        • Browser blocking external scripts<br>
                        • Ad blocker interference<br>
                        • Mapbox API rate limits
                    </div>
                    <button class="retry-button" onclick="retryMapLoad()">Try Again</button>
                    <div style="font-size: 0.8rem; margin-top: 15px; color: var(--light-text);">
                        Coffee shops are still browsable in the sidebar →
                    </div>
                </div>
            `;
        }

        function retryMapLoad() {
            if (retryCount < maxRetries) {
                retryCount++;
                showLoadingMessage();
                setTimeout(() => {
                    loadMapboxWithFallback();
                }, 1000);
            } else {
                showErrorMessage();
            }
        }

        async function geocodeAddress(address, accessToken) {
            try {
                const encodedAddress = encodeURIComponent(address);
                const response = await fetch(
                    `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodedAddress}.json?access_token=${accessToken}&country=CA&bbox=-123.3,49.0,-122.5,49.5`
                );
                
                if (!response.ok) {
                    throw new Error(`Geocoding failed: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.features && data.features.length > 0) {
                    const [longitude, latitude] = data.features[0].center;
                    return [longitude, latitude];
                } else {
                    console.warn(`No results found for address: ${address}`);
                    return null;
                }
            } catch (error) {
                console.error(`Error geocoding ${address}:`, error);
                return null;
            }
        }

        function loadMapboxWithFallback() {
            const mapboxConfigs = [
                {
                    js: 'https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js',
                    css: 'https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css'
                },
                {
                    js: 'https://unpkg.com/mapbox-gl@2.15.0/dist/mapbox-gl.js',
                    css: 'https://unpkg.com/mapbox-gl@2.15.0/dist/mapbox-gl.css'
                },
                {
                    js: 'https://cdn.jsdelivr.net/npm/mapbox-gl@2.15.0/dist/mapbox-gl.js',
                    css: 'https://cdn.jsdelivr.net/npm/mapbox-gl@2.15.0/dist/mapbox-gl.css'
                }
            ];

            let currentConfig = 0;

            function tryLoadMapbox() {
                if (currentConfig >= mapboxConfigs.length) {
                    console.log('All Mapbox CDN sources failed');
                    showErrorMessage();
                    return;
                }

                const config = mapboxConfigs[currentConfig];
                
                const cssLink = document.createElement('link');
                cssLink.rel = 'stylesheet';
                cssLink.href = config.css;
                document.head.appendChild(cssLink);

                const script = document.createElement('script');
                script.src = config.js;
                script.onload = initializeMap;
                script.onerror = () => {
                    console.log(`Failed to load Mapbox from ${config.js}, trying next...`);
                    currentConfig++;
                    setTimeout(tryLoadMapbox, 2000);
                };
                
                setTimeout(() => {
                    if (typeof mapboxgl === 'undefined') {
                        console.log(`Timeout loading ${config.js}`);
                        script.onerror();
                    }
                }, 10000);
                
                document.head.appendChild(script);
            }

            tryLoadMapbox();
        }

        async function initializeMap() {
            if (typeof mapboxgl === 'undefined') {
                console.log('Mapbox GL still not defined after script load');
                showErrorMessage();
                return;
            }

            try {
                const accessToken = 'pk.eyJ1IjoibWVsb2R5b29vbyIsImEiOiJjbWV3NzJ4bWkwc2I4MnJvYThhNjljNHg0In0.H7rgmxgNiBL-AW_qhK7VNA';
                mapboxgl.accessToken = accessToken;

                document.getElementById('map').innerHTML = '';

                map = new mapboxgl.Map({
                    container: 'map',
                    style: 'mapbox://styles/mapbox/streets-v12',
                    center: [-123.1207, 49.2827],
                    zoom: 11,
                    attributionControl: true
                });

                map.on('error', (e) => {
                    console.error('Map error:', e);
                    try {
                        map.setStyle('mapbox://styles/mapbox/light-v10');
                    } catch (fallbackError) {
                        console.error('Fallback style also failed:', fallbackError);
                        showErrorMessage();
                    }
                });

                // Get all coffee shop elements with addresses
                const coffeeShopElements = document.querySelectorAll('.category-item[data-address]');
                totalShops = coffeeShopElements.length;

                // Coffee shop data with categories
                const coffeeShopsData = [
                    // Best of the Best
                    { name: 'R Ki Coffee Lab', address: '8280 Lansdowne Rd #110, Richmond, BC V6X 0B2', website: 'http://www.rkicoffeelab.com/', category: 'best', description: 'Premium coffee laboratory experience in Richmond' },
                    { name: 'Oidé Coffee', address: '1548 W 2nd Ave, Vancouver, BC V6J 1H2', website: 'https://www.instagram.com/oidecoffee/?hl=ja', category: 'best', description: 'Japanese-inspired coffee culture in Kitsilano' },
                    { name: 'Revolver', address: '325 Cambie St, Vancouver, BC V6B 2N4', website: 'http://revolvercoffee.ca/', category: 'best', description: 'Third-wave coffee pioneer in historic Gastown' },
                    { name: 'Coffee Roastery Modus', address: '112 W Broadway, Vancouver, BC V5Y 1P1', website: 'http://www.moduscoffee.com/', category: 'best', description: 'Vancouver based micro-roaster working with exceptional single origin specialty coffees' },
                    { name: 'Yuán Coffee', address: '550 Clark Dr, Vancouver, BC V5L 3H7', website: 'https://www.instagram.com/yuancoffeeyvr/', category: 'best', description: 'Specialty coffee with distinctive character' },
                    { name: 'Isetta Cafe Bistro', address: '4360 Marine Dr, West Vancouver, BC V7V 1P1', website: 'http://isetta.ca/', category: 'best', description: 'Nestled between ocean and mountains, serving good food, drink and warm experiences' },
                    { name: 'Nemesis Coffee GNW', address: '555 Great Northern Way, Vancouver, BC V5T 1E1', website: 'https://www.nemesis.coffee/', category: 'best', description: 'Monthly curation of arts, music, entertainment, and caffeine for creators and dreamers' },

                    // Hidden Gems
                    { name: 'Craft Cafe', address: '960 Quayside Dr Unit 115, New Westminster, BC V3M 6G2', website: 'http://craftcafe.ca/', category: 'hidden', description: 'Emphasizing community, quality, and memorable experiences from coffee to cocktails' },
                    { name: 'cowdog coffee', address: '2040 Quebec St, Vancouver, BC V5T 1Z7', website: 'http://www.cowdog.coffee/', category: 'hidden', description: 'Pretty good coffee, matcha and bites in a unique neighborhood setting' },
                    { name: 'Doe Coffee', address: '2263 E Hastings St, Vancouver, BC V5L 1V3', website: 'http://www.doecoffee.com/', category: 'hidden', description: 'Roaster & bakery with signature Morning Glory blend and pour-over quality drip bags' },
                    { name: 'Lumine Coffee', address: '1965 W 4th Ave #103, Vancouver, BC V6J 1M8', website: 'http://www.luminecoffee.com/', category: 'hidden', description: 'Minimalist coffee bar in Kitsilano' },
                    { name: 'Timbertrain Coffee Roasters - Gastown', address: '311 W Cordova St, Vancouver, BC V6B 4K2', website: 'http://timbertraincoffeeroasters.com/', category: 'hidden', description: 'Local roastery in historic Gastown' },
                    { name: 'East Van Roasters', address: '319 Carrall St, Vancouver, BC V6B 2J4', website: 'http://eastvanroasters.com/', category: 'hidden', description: 'Community-focused coffee roasters' },
                    { name: 'KAFFI Espresso Bar', address: '2624B St Johns St, Port Moody, BC V3H 2B6', website: 'http://www.kaffiespressobar.ca/', category: 'hidden', description: 'Nordic-inspired coffee culture' },
                    { name: 'Kits Beach Coffee', address: '1945 Cornwall Ave, Vancouver, BC V6J 1C8', website: 'http://www.kitsbeachcoffee.com/', category: 'hidden', description: 'Beachside coffee experience' },
                    { name: 'Small Victory Bakery', address: '388 W 6th Ave, Vancouver, BC V5Y 1L1', website: 'http://www.smallvictory.ca/', category: 'hidden', description: 'Artisan bakery and coffee' },
                    { name: 'FUNK. Coffee Bar', address: '1025 Dunsmuir St, Vancouver, BC V7X 1M5', website: 'https://www.funkcoffeebar.com/', category: 'hidden', description: 'Funky coffee roasters' },
                    { name: 'Single V Coffee', address: '5000 Kingsway #140, Burnaby, BC V5H 2E4', website: 'http://singlev.com/', category: 'hidden', description: 'Single origin focus' },
                    { name: 'VERONI & CO. Burnaby', address: '4501 North Rd #219, Burnaby, BC V3N 4R7', website: 'http://veroni.co/', category: 'hidden', description: 'Italian coffee tradition' },
                    { name: 'Saunter Coffee', address: '321 W Pender St, Vancouver, BC V6B 1T3', website: '', category: 'hidden', description: 'Downtown coffee sanctuary' },
                    { name: 'Mah Milk Bar - Victoria Dr', address: '1502 Victoria Dr, Vancouver, BC V5L 2Y9', website: 'https://www.mahmilkbar.com/', category: 'hidden', description: 'Asian-inspired coffee drinks' },
                    { name: 'Coasters Coffee', address: '55 6th St, New Westminster, BC V3L 0J2', website: 'http://coasterscoffee.com/', category: 'hidden', description: 'Neighborhood coffee spot' },
                    { name: 'Artisan Eats Café & Fine Foods', address: '539 Artisan Ln, Bowen Island, BC V0N 1G0', website: 'http://www.artisaneats.ca/', category: 'hidden', description: 'Gourmet café experience' },
                    { name: 'NOMAD Coffee & Bakery', address: '1415 Bewicke Ave, North Vancouver, BC V7M 3B8', website: 'http://www.nomadyvr.ca/', category: 'hidden', description: 'Community bakery and café' },
                    { name: 'Slo Coffee', address: '4160 Fraser St, Vancouver, BC V5V 4E8', website: 'http://www.slocoffee.ca/', category: 'hidden', description: 'Slow coffee movement' },
                    { name: 'Aiyaohno Cafe', address: '425 Carrall St, Vancouver, BC V6B 6E3', website: 'http://www.aiyaohno.com/', category: 'hidden', description: 'Asian fusion café' },
                    { name: 'Their There', address: '2042 W 4th Ave, Vancouver, BC V6J 1M9', website: 'http://www.theirthere.ca/', category: 'hidden', description: 'Thoughtful coffee curation' },
                    { name: 'The Federal Store Luncheonette & Grocer', address: '2601 Quebec St, Vancouver, BC V5T 3A6', website: 'http://federalstore.ca/', category: 'hidden', description: 'Vintage-inspired eatery' },
                    { name: 'Annabelle\'s', address: '620 Quebec St, Vancouver, BC V6A 4E7', website: 'https://www.annabellechoistudio.com/', category: 'hidden', description: 'Charming neighborhood café' },
                    { name: 'Cafe Algan', address: '688 W 58th Ave, Vancouver, BC V6P 0K1', website: 'http://www.cafealgan.com/', category: 'hidden', description: 'Turkish coffee culture' },
                    { name: 'Hooray Cafe & Coffee Lab', address: '6450 Roberts St #100, Burnaby, BC V5G 4E1', website: 'https://hooraycoffee.ca/', category: 'hidden', description: 'Experimental coffee lab' },
                    { name: 'Viva Cafe & Bakery', address: '1555 Yew St, Vancouver, BC V6K 3E5', website: 'http://vivacafe.ca/', category: 'hidden', description: 'European-style café' },
                    { name: 'Ibex café + kitchen', address: '3537 Princeton Ave, Coquitlam, BC V3E 0P1', website: 'http://www.cafeibex.ca/', category: 'hidden', description: 'Beautiful café in Coquitlam' },
                    { name: 'Steveston Coffee Company', address: '3511 Moncton St, Richmond, BC V7E 3A3', website: 'https://www.stevestoncoffee.ca/', category: 'hidden', description: 'Waterfront coffee in historic Steveston' },
                    { name: 'Union Market', address: '810 Union St, Vancouver, BC V6A 2C4', website: 'http://www.unionmarket.ca/', category: 'hidden', description: 'Market café in Strathcona' },
                    { name: 'Jack\'s Spot', address: '3615 Kingsway, Vancouver, BC V5R 5M1', website: 'https://www.instagram.com/jacks__spot?igsh=dmttZXYwYTZzZnd4', category: 'hidden', description: 'Local favorite spot' },

                    // Work & Study
                    { name: 'Standing Egg Coffee', address: '4501 North Rd #109A, Burnaby, BC V3N 4R7', website: 'https://standingeggcoffee.webflow.io/', category: 'work', description: 'Perfect for laptop sessions and study' },
                    { name: 'JJ Bean Coffee Roasters', address: '3399 Cambie St, Vancouver, BC V5Z 2W6', website: 'https://jjbeancoffee.com/', category: 'work', description: 'Spacious with WiFi and power outlets' },
                    { name: 'Analog Coffee', address: '338 Helmcken St, Vancouver, BC V6B 6C5', website: 'https://www.analogcoffee.ca/', category: 'work', description: 'Digital nomad friendly' },
                    { name: 'Coffee loft', address: '4462 Beresford St., Burnaby, BC V5H 2Y8', website: '', category: 'work', description: 'Multi-level workspace' },
                    { name: 'Terra Breads', address: '1605 Manitoba St, Vancouver, BC V5Y 3B7', website: 'http://www.terrabreads.com/', category: 'work', description: 'Bakery with workspace' },
                    { name: 'Good Earth Coffeehouse - Robson', address: '1033 Robson St, Vancouver, BC V6E 1A9', website: 'https://goodearthcoffeehouse.com/location/indigo-robson-street/', category: 'work', description: 'Chain with reliable WiFi' },
                    { name: 'Matchstick Fraser Street', address: '639 E 15th Ave, Vancouver, BC V5T 2R6', website: 'http://matchstickyvr.com/', category: 'work', description: 'Popular workspace spot' },
                    { name: 'Birds & The Beets', address: '55 Powell St, Vancouver, BC V6A 1E9', website: 'http://www.birdsandbeets.ca/', category: 'work', description: 'Health-focused café' },
                    { name: 'Propaganda coffee', address: '209 E Pender St, Vancouver, BC V6A 1T8', website: 'http://www.propagandacoffee.ca/', category: 'work', description: 'Study-friendly atmosphere' },
                    { name: '49th Parallel Café & Lucky\'s Doughnuts - West 4th', address: '2198 W 4th Ave, Vancouver, BC V6K 1N7', website: 'http://luckysdoughnuts.com/', category: 'work', description: 'Popular coffee chain' },
                    { name: 'Milano Coffee Roasters', address: '156 W 8th Ave, Vancouver, BC V5Y 1N2', website: 'https://www.milanocoffee.ca/', category: 'work', description: 'Italian-style roastery' },
                    { name: 'Forecast Coffee', address: '2980 Main St, Vancouver, BC V5T 3G3', website: 'http://forecastcoffee.ca/', category: 'work', description: 'Weather-themed café' },
                    { name: 'Caffè Super Veloce', address: '1067 W Cordova St #150, Vancouver, BC V6C 1C7', website: 'https://www.caffesuperveloce.com/', category: 'work', description: 'Fast WiFi guaranteed' },
                    { name: 'Grounds for Coffee', address: '2088 Commercial Dr, Vancouver, BC V5N 4B2', website: 'https://groundsforcoffee.ca/', category: 'work', description: 'Study groups welcome' },
                    { name: 'AVIK', address: '682 W Broadway, Vancouver, BC V5Z 1G1', website: 'http://avikcafe.com/', category: 'work', description: 'Productivity-focused space' },
                    { name: 'Bastion Coffee + Kitchen', address: '3713 Kensington Ave, Burnaby, BC V5B 0A7', website: 'https://foodburnaby.ca/cafes/bastion-cafe', category: 'work', description: 'All-day workspace' },
                    { name: 'Matchstick Yaletown', address: '1328 Richards St, Vancouver, BC V6B 3G6', website: 'https://matchstickyvr.com/pages/cafes-title', category: 'work', description: 'Downtown location' },

                    // Honorable Mention
                    { name: 'Small Victory Bakery', address: '1089 Marinaside Crescent, Vancouver, BC V6Z 2Z4', website: 'http://www.smallvictory.ca/', category: 'honorable', description: 'Artisan bakery and coffee' },
                    { name: 'Nelson the Seagull Cafe', address: '315 Carrall St, Vancouver, BC V6B 2J4', website: 'http://www.nelsontheseagull.com/', category: 'honorable', description: 'Famous for sourdough and beautiful interior' },
                    { name: 'Rocanini Coffee Roasters', address: '863 Beatty St, Vancouver, BC V6B 2M6', website: 'https://www.rocanini.com/', category: 'honorable', description: 'Local roasting institution' },
                    { name: 'Prototype Coffee', address: '883 E Hastings St, Vancouver, BC V6A 1R8', website: 'https://www.prototypecoffee.ca/', category: 'honorable', description: 'Innovative coffee concepts' }
                ];

                const categoryColors = {
                    best: '#4A00C9',        // Dark Blue
                    hidden: '#FF5E32',     // Portland Orange
                    work: '#B7CF4F',       // June Bud
                    honorable: '#8B5A96'   // Purple
                };

                map.on('load', async () => {
                    // Geocode all addresses and add markers
                    const geocodingPromises = coffeeShopsData.map(async (shop) => {
                        const coordinates = await geocodeAddress(shop.address, accessToken);
                        geocodedCount++;
                        updateGeocodingStatus(geocodedCount, totalShops);
                        
                        if (coordinates) {
                            const el = document.createElement('div');
                            el.className = 'custom-marker';
                            el.style.backgroundColor = categoryColors[shop.category] || '#4A00C9';
                            el.style.width = '18px';
                            el.style.height = '18px';

                            const popupContent = `
                                <div class="popup-content">
                                    <h3>${shop.name}</h3>
                                    <p><a href="#" class="address-link" onclick="openInGoogleMaps('${shop.address}'); return false;">${shop.address}</a></p>
                                    ${shop.website ? `<a href="${shop.website}" target="_blank" class="website-icon" title="Visit Website">🌐</a>` : ''}
                                </div>
                            `;

                            const popup = new mapboxgl.Popup({ offset: 15 }).setHTML(popupContent);
                            const marker = new mapboxgl.Marker(el)
                                .setLngLat(coordinates)
                                .setPopup(popup)
                                .addTo(map);

                            markers.push({ marker, shop, element: el, coordinates });

                            // Update the sidebar element with the geocoded coordinates
                            const sidebarItem = document.querySelector(`[data-address="${shop.address}"]`);
                            if (sidebarItem) {
                                sidebarItem.setAttribute('data-coords', JSON.stringify(coordinates));
                            }
                        }
                        
                        return { shop, coordinates };
                    });

                    // Wait for all geocoding to complete
                    await Promise.all(geocodingPromises);
                });

                // Handle sidebar clicks
                document.addEventListener('click', function(e) {
                    if (e.target.classList.contains('category-item') && e.target.getAttribute('data-coords')) {
                        document.querySelectorAll('.category-item').forEach(i => i.classList.remove('active'));
                        e.target.classList.add('active');

                        const coords = JSON.parse(e.target.getAttribute('data-coords'));
                        map.flyTo({ center: coords, zoom: 15, duration: 1000 });

                        const shopName = e.target.textContent.trim();
                        const markerData = markers.find(m => m.shop.name === shopName);
                        if (markerData) {
                            markerData.marker.getPopup().addTo(map);
                        }
                    }
                });

                map.addControl(new mapboxgl.NavigationControl());

            } catch (error) {
                console.error('Error initializing map:', error);
                showErrorMessage();
            }
        }

        function toggleCategory(header) {
            const category = header.parentElement;
            category.classList.toggle('expanded');
        }

        document.addEventListener('DOMContentLoaded', function() {
            showLoadingMessage();
            setTimeout(loadMapboxWithFallback, 1000);
        });
    </script>


</body></html>
